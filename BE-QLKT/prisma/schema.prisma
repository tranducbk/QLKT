generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. Bảng Cơ quan đơn vị
model CoQuanDonVi {
  id         String   @id @default(cuid()) @db.VarChar(30)
  ma_don_vi  String   @unique @db.VarChar(50)
  ten_don_vi String   @db.VarChar(255)
  so_luong   Int      @default(0)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  ChucVu                 ChucVu[]
  DonViTrucThuoc         DonViTrucThuoc[]
  QuanNhan               QuanNhan[]
  BangDeXuat             BangDeXuat[]
  DanhHieuDonViHangNam   DanhHieuDonViHangNam[]
  HoSoDonViHangNam       HoSoDonViHangNam[]
  KhenThuongDotXuat       KhenThuongDotXuat[]

  @@map("co_quan_don_vi")
}

// 2. Bảng Đơn vị trực thuộc
model DonViTrucThuoc {
  id                String   @id @default(cuid()) @db.VarChar(30)
  co_quan_don_vi_id String   @db.VarChar(30) // ID cơ quan đơn vị
  ma_don_vi         String   @unique @db.VarChar(50)
  ten_don_vi        String   @db.VarChar(255)
  so_luong          Int      @default(0)
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  CoQuanDonVi              CoQuanDonVi              @relation(fields: [co_quan_don_vi_id], references: [id], onDelete: Cascade)
  ChucVu                   ChucVu[]
  QuanNhan                 QuanNhan[]
  BangDeXuat               BangDeXuat[]
  DanhHieuDonViHangNam     DanhHieuDonViHangNam[]
  HoSoDonViHangNam         HoSoDonViHangNam[]
  KhenThuongDotXuat         KhenThuongDotXuat[]

  @@map("don_vi_truc_thuoc")
}

// 3. Bảng Chức vụ
model ChucVu {
  id                   String   @id @default(cuid()) @db.VarChar(30)
  co_quan_don_vi_id     String?  @db.VarChar(30) // ID cơ quan đơn vị (nullable)
  don_vi_truc_thuoc_id  String?  @db.VarChar(30) // ID đơn vị trực thuộc (nullable)
  ten_chuc_vu           String   @db.VarChar(255)
  is_manager             Boolean  @default(false)
  he_so_chuc_vu         Decimal  @default(0) @db.Decimal(10, 2) // Hệ số chức vụ
  createdAt             DateTime @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  CoQuanDonVi    CoQuanDonVi?    @relation(fields: [co_quan_don_vi_id], references: [id], onDelete: Cascade)
  DonViTrucThuoc DonViTrucThuoc? @relation(fields: [don_vi_truc_thuoc_id], references: [id], onDelete: Cascade)
  QuanNhan       QuanNhan[]
  LichSuChucVu   LichSuChucVu[]

  @@unique([co_quan_don_vi_id, ten_chuc_vu])
  @@unique([don_vi_truc_thuoc_id, ten_chuc_vu])
  @@map("chuc_vu")
}

// 4. Bảng Quân nhân
model QuanNhan {
  id                       String    @id @default(cuid()) @db.VarChar(30)
  cccd                     String?   @unique @db.VarChar(20)
  ho_ten                   String    @db.VarChar(255)
  gioi_tinh                String?   @db.VarChar(10) // NAM hoặc NU
  ngay_sinh                DateTime? @db.Date
  que_quan_2_cap           String?   @db.VarChar(255) // Quê quán 2 cấp: Xã Hoà An, tỉnh Ninh Bình
  que_quan_3_cap           String?   @db.VarChar(255) // Quê quán 3 cấp: Xã An Hoà, huyện Yên Bình, tỉnh Nam Định
  tru_quan                 String?   @db.VarChar(255) // Trú quán 2 cấp: Xã Hoà An, tỉnh Ninh Bình
  cho_o_hien_nay           String?   @db.VarChar(255) // Chỗ ở hiện nay 2 cấp: Xã Hoà An, tỉnh Ninh Bình
  co_quan_don_vi           Json? // JSON lưu thông tin cơ quan đơn vị
  ngay_nhap_ngu            DateTime? @db.Date // Phục vụ cho tính thời gian cống hiến
  ngay_xuat_ngu            DateTime? @db.Date // Phục vụ cho tính thời gian để nhận Kỷ niệm chương (20 năm nữ, 25 năm nam)
  ngay_vao_dang            DateTime? @db.Date // Ngày vào Đảng
  ngay_vao_dang_chinh_thuc DateTime? @db.Date // Ngày vào Đảng chính thức
  so_the_dang_vien         String?   @db.VarChar(50) // Số thẻ Đảng viên
  so_dien_thoai            String?   @db.VarChar(20) // Số điện thoại
  cap_bac                  String?   @db.VarChar(50) // Cấp bậc: Binh nhì, Binh nhất, Hạ sĩ, Trung sĩ, Thượng sĩ, Thiếu úy, Trung úy, Thượng úy, Đại úy, Thiếu tá, Trung tá, Thượng tá, Đại tá, Thiếu tướng, Trung tướng, Thượng tướng, Đại tướng
  co_quan_don_vi_id        String?   @db.VarChar(30) // ID cơ quan đơn vị (nullable)
  don_vi_truc_thuoc_id     String?   @db.VarChar(30) // ID đơn vị trực thuộc (nullable)
  chuc_vu_id               String    @db.VarChar(30)
  createdAt                DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt                DateTime  @updatedAt @db.Timestamptz(6)

  // Relations
  CoQuanDonVi      CoQuanDonVi?      @relation(fields: [co_quan_don_vi_id], references: [id], onDelete: Cascade)
  DonViTrucThuoc    DonViTrucThuoc?   @relation(fields: [don_vi_truc_thuoc_id], references: [id], onDelete: Cascade)
  ChucVu            ChucVu            @relation(fields: [chuc_vu_id], references: [id], onDelete: Restrict)
  TaiKhoan          TaiKhoan?
  LichSuChucVu      LichSuChucVu[]
  ThanhTichKhoaHoc  ThanhTichKhoaHoc[]
  DanhHieuHangNam   DanhHieuHangNam[]
  KhenThuongCongHien KhenThuongCongHien?
  KhenThuongHCCSVV   KhenThuongHCCSVV[]
  KhenThuongDotXuat  KhenThuongDotXuat[]
  HuanChuongQuanKyQuyetThang HuanChuongQuanKyQuyetThang?
  KyNiemChuongVSNXDQDNDVN KyNiemChuongVSNXDQDNDVN?
  HoSoNienHan       HoSoNienHan?
  HoSoHangNam       HoSoHangNam?

  @@map("quan_nhan")
}

// 5. Bảng Tài khoản
model TaiKhoan {
  id            String   @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id  String?  @unique @db.VarChar(30)
  username      String   @unique @db.VarChar(100)
  password_hash String   @db.VarChar(255)
  role          String   @db.VarChar(20) // SUPER_ADMIN, ADMIN, MANAGER, USER
  refreshToken  String?  @db.Text
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan               QuanNhan?                @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)
  SystemLogs             SystemLog[]              @relation("NguoiThucHien")
  DeXuatDaGui            BangDeXuat[]             @relation("NguoiDeXuat")
  DeXuatDaDuyet          BangDeXuat[]             @relation("NguoiDuyet")
  ThongBao               ThongBao[] @relation("NguoiNhan") // Thông báo nhận được

  @@map("tai_khoan")
}

// 6. Bảng Lịch sử chức vụ (INPUT - để tính cống hiến)
model LichSuChucVu {
  id            String    @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id  String    @db.VarChar(30)
  chuc_vu_id    String    @db.VarChar(30)
  he_so_chuc_vu Float     @default(0) // Hệ số chức vụ tại thời điểm đó (lưu snapshot)
  ngay_bat_dau  DateTime  @db.Date
  ngay_ket_thuc DateTime? @db.Date
  so_thang      Int?      // Số tháng giữ chức vụ (tính từ ngày bắt đầu đến ngày kết thúc, tính tới tháng)
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)
  ChucVu   ChucVu   @relation(fields: [chuc_vu_id], references: [id], onDelete: Cascade)

  @@map("lich_su_chuc_vu")
}

// 7. Bảng Thành tích khoa học (INPUT)
model ThanhTichKhoaHoc {
  id              String   @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id    String   @db.VarChar(30)
  nam             Int
  loai            String   @db.VarChar(10) // NCKH, SKKH
  mo_ta           String   @db.VarChar(500)
  status          String   @default("PENDING") @db.VarChar(20) // APPROVED, PENDING
  so_quyet_dinh   String?  @db.VarChar(100) // Số quyết định khen thưởng (nếu có)
  file_quyet_dinh String?  @db.VarChar(255) // Tên file PDF quyết định (nếu có)
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)

  @@map("thanh_tich_khoa_hoc")
}

// 8. Bảng Danh hiệu hằng năm (INPUT + OUTPUT)
model DanhHieuHangNam {
  id                     String   @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id           String   @db.VarChar(30)
  nam                    Int
  danh_hieu              String?  @db.VarChar(20) // CSTDCS, CSTT (null = không đạt)
  so_quyet_dinh          String?  @db.VarChar(100) // Số quyết định danh hiệu
  file_quyet_dinh        String?  @db.VarChar(500) // Path to PDF file
  nhan_bkbqp             Boolean  @default(false)
  so_quyet_dinh_bkbqp    String?  @db.VarChar(100)
  file_quyet_dinh_bkbqp  String?  @db.VarChar(500) // Path to PDF file BKBQP
  nhan_cstdtq            Boolean  @default(false)
  so_quyet_dinh_cstdtq   String?  @db.VarChar(100)
  file_quyet_dinh_cstdtq String?  @db.VarChar(500) // Path to PDF file CSTDTQ
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)

  @@unique([quan_nhan_id, nam])
  @@map("danh_hieu_hang_nam")
}

// 9. Bảng Khen thưởng Cống hiến (OUTPUT)
model KhenThuongCongHien {
  id                     String   @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id           String   @unique @db.VarChar(30) // Mỗi quân nhân chỉ có 1 danh hiệu cống hiến
  danh_hieu              String   @db.VarChar(20) // HCBVTQ_HANG_BA, HCBVTQ_HANG_NHI, HCBVTQ_HANG_NHAT
  nam                    Int // Năm được trao
  so_quyet_dinh          String?  @db.VarChar(100) // Số quyết định
  file_quyet_dinh        String?  @db.VarChar(500) // Path to PDF file
  // Thời gian đảm nhiệm chức vụ theo 3 nhóm hệ số
  thoi_gian_nhom_0_7     Json? // { total_months, years, months, display }
  thoi_gian_nhom_0_8     Json? // { total_months, years, months, display }
  thoi_gian_nhom_0_9_1_0 Json? // { total_months, years, months, display }
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)

  @@map("khen_thuong_cong_hien")
}

// 10. Bảng Khen thưởng Huy chương Quân kỳ quyết thắng (OUTPUT)
model HuanChuongQuanKyQuyetThang {
  id                     String   @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id           String   @unique @db.VarChar(30) // Mỗi quân nhân chỉ có 1 huân chương
  nam                    Int // Năm được trao
  so_quyet_dinh          String?  @db.VarChar(100) // Số quyết định
  file_quyet_dinh        String?  @db.VarChar(500) // Path to PDF file
  // Thời gian tính từ ngày nhập ngũ
  thoi_gian              Json? // { total_months, years, months, display }
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)

  @@map("huan_chuong_quan_ky_quyet_thang")
}

// 11. Bảng Kỷ niệm chương Vì sự nghiệp xây dựng QĐNDVN (OUTPUT)
model KyNiemChuongVSNXDQDNDVN {
  id                     String   @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id           String   @unique @db.VarChar(30) // Mỗi quân nhân chỉ có 1 kỷ niệm chương
  nam                    Int // Năm được trao
  so_quyet_dinh          String?  @db.VarChar(100) // Số quyết định
  file_quyet_dinh        String?  @db.VarChar(500) // Path to PDF file
  // Thời gian tính từ ngày nhập ngũ
  thoi_gian              Json? // { total_months, years, months, display }
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)

  @@map("ky_niem_chuong_vsnxd_qdndvn")
}

// 12. Bảng Khen thưởng Huân chương Chiến sĩ Vẻ vang (OUTPUT)
model KhenThuongHCCSVV {
  id                     String   @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id           String   @db.VarChar(30)
  danh_hieu              String   @db.VarChar(20) // HCCSVV_HANG_BA, HCCSVV_HANG_NHI, HCCSVV_HANG_NHAT
  nam                    Int // Năm được trao
  so_quyet_dinh          String?  @db.VarChar(100) // Số quyết định
  file_quyet_dinh        String?  @db.VarChar(500) // Path to PDF file
  // Thời gian tính từ ngày nhập ngũ
  thoi_gian              Json? // { total_months, years, months, display }
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)

  // Mỗi người chỉ có tối đa 1 bản ghi cho mỗi hạng
  @@unique([quan_nhan_id, danh_hieu])
  @@map("khen_thuong_hccsvv")
}

// 13. Bảng Khen thưởng Đột xuất (OUTPUT)
model KhenThuongDotXuat {
  id                     String   @id @default(cuid()) @db.VarChar(30)
  loai                   String   @db.VarChar(20) // CA_NHAN, TAP_THE
  quan_nhan_id           String?  @db.VarChar(30) // ID quân nhân (khi loai = CA_NHAN)
  co_quan_don_vi_id      String?  @db.VarChar(30) // ID cơ quan đơn vị (khi loai = TAP_THE và don_vi_type = CO_QUAN_DON_VI)
  don_vi_truc_thuoc_id   String?  @db.VarChar(30) // ID đơn vị trực thuộc (khi loai = TAP_THE và don_vi_type = DON_VI_TRUC_THUOC)
  hinh_thuc_khen_thuong  String   @db.VarChar(255) // Ví dụ: "Giấy khen của abc", "Bằng khen của def"
  nam                    Int // Năm nhận khen thưởng
  so_quyet_dinh          String?  @db.VarChar(100) // Số quyết định
  file_quyet_dinh        String?  @db.VarChar(500) // Path to PDF file
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan      QuanNhan?      @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)
  CoQuanDonVi   CoQuanDonVi?   @relation(fields: [co_quan_don_vi_id], references: [id], onDelete: Cascade)
  DonViTrucThuoc DonViTrucThuoc? @relation(fields: [don_vi_truc_thuoc_id], references: [id], onDelete: Cascade)

  @@index([quan_nhan_id, nam])
  @@index([co_quan_don_vi_id, nam])
  @@index([don_vi_truc_thuoc_id, nam])
  @@map("khen_thuong_dot_xuat")
}

// 14. Bảng Hồ sơ Niên hạn (OUTPUT)
model HoSoNienHan {
  id           String @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id String @unique @db.VarChar(30)

  // Huân chương Chiến sĩ vẻ vang (HCCSVV)
  hccsvv_hang_ba_status   String    @default("CHUA_DU") @db.VarChar(20) // CHUA_DU, DU_DIEU_KIEN, DA_NHAN
  hccsvv_hang_ba_ngay     DateTime? @db.Date
  hccsvv_hang_nhi_status  String    @default("CHUA_DU") @db.VarChar(20)
  hccsvv_hang_nhi_ngay    DateTime? @db.Date
  hccsvv_hang_nhat_status String    @default("CHUA_DU") @db.VarChar(20)
  hccsvv_hang_nhat_ngay   DateTime? @db.Date

  // Huân chương Bảo vệ Tổ quốc (HCBVTQ - Cống hiến) - DEPRECATED: Dùng bảng KhenThuongCongHien
  hcbvtq_total_months     Int    @default(0)
  hcbvtq_hang_ba_status   String @default("CHUA_DU") @db.VarChar(20)
  hcbvtq_hang_nhi_status  String @default("CHUA_DU") @db.VarChar(20)
  hcbvtq_hang_nhat_status String @default("CHUA_DU") @db.VarChar(20)

  goi_y     String?  @db.Text
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)

  @@map("ho_so_nien_han")
}

// 10. Bảng Hồ sơ Hằng năm (OUTPUT)
model HoSoHangNam {
  id                  String   @id @default(cuid()) @db.VarChar(30)
  quan_nhan_id        String   @unique @db.VarChar(30)
  tong_cstdcs         Int      @default(0)
  tong_nckh           Int      @default(0)
  tong_cstdcs_json    Json?    // Lưu chi tiết danh hiệu dạng JSON
  tong_nckh_json      Json?    // Lưu chi tiết NCKH dạng JSON
  cstdcs_lien_tuc     Int      @default(0)
  du_dieu_kien_bkbqp  Boolean  @default(false)
  du_dieu_kien_cstdtq Boolean  @default(false)
  goi_y               String?  @db.Text
  createdAt           DateTime @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  QuanNhan QuanNhan @relation(fields: [quan_nhan_id], references: [id], onDelete: Cascade)

  @@map("ho_so_hang_nam")
}

// 11. Bảng Nhật ký hệ thống
model SystemLog {
  id                String   @id @default(cuid()) @db.VarChar(30)
  nguoi_thuc_hien_id String   @db.VarChar(30) // ID của người thực hiện hành động
  actor_role        String   @db.VarChar(20) // SUPER_ADMIN, ADMIN, MANAGER, USER
  action            String   @db.VarChar(50) // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  resource          String   @db.VarChar(50) // accounts, personnel, positions, etc.
  tai_nguyen_id     String?  @db.VarChar(30) // ID của tài nguyên bị tác động
  description       String   @db.VarChar(500) // Mô tả hành động
  payload           Json? // Dữ liệu chi tiết (before/after values)
  ip_address        String?  @db.VarChar(45) // IPv4/IPv6
  user_agent        String?  @db.Text
  created_at        DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  NguoiThucHien TaiKhoan   @relation("NguoiThucHien", fields: [nguoi_thuc_hien_id], references: [id], onDelete: Cascade)
  ThongBao      ThongBao[] @relation("NhatKyHeThong") // Thông báo được tạo từ log này

  @@index([actor_role, created_at])
  @@index([action, created_at])
  @@index([resource, created_at])
  @@map("system_logs")
}

// 13. Bảng Thông báo (Notifications)
model ThongBao {
  id                 Int       @id @default(autoincrement()) @db.Integer
  nguoi_nhan_id      String?   @db.VarChar(30) // ID người nhận thông báo
  recipient_role     String    @db.VarChar(20) // SUPER_ADMIN, ADMIN, MANAGER, USER
  type               String    @db.VarChar(50) // NEW_PERSONNEL, APPROVAL_PENDING, ACHIEVEMENT_SUBMITTED, etc.
  title              String    @db.VarChar(255) // Tiêu đề thông báo
  message            String    @db.VarChar(500) // Nội dung thông báo
  resource           String?   @db.VarChar(50) // personnel, achievements, proposals, etc.
  tai_nguyen_id      String?   @db.VarChar(30) // ID của tài nguyên liên quan
  link               String?   @db.VarChar(255) // URL để navigate đến
  is_read            Boolean   @default(false) // Đã đọc chưa
  nhat_ky_he_thong_id String?   @db.VarChar(30) // ID của system log liên quan (nếu có)
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  read_at            DateTime? @db.Timestamptz(6) // Thời gian đọc

  // Relations
  NguoiNhan TaiKhoan?   @relation("NguoiNhan", fields: [nguoi_nhan_id], references: [id], onDelete: Cascade)
  NhatKyHeThong SystemLog? @relation("NhatKyHeThong", fields: [nhat_ky_he_thong_id], references: [id], onDelete: SetNull)

  @@index([nguoi_nhan_id, is_read, created_at])
  @@index([recipient_role, is_read, created_at])
  @@index([type, created_at])
  @@map("notifications")
}

// 14. Bảng Đề xuất Khen thưởng (Proposals)
model BangDeXuat {
  id                   String    @id @default(cuid()) @db.VarChar(30)
  co_quan_don_vi_id    String?   @db.VarChar(30) // ID cơ quan đơn vị của Manager nộp đề xuất (nullable)
  don_vi_truc_thuoc_id String?   @db.VarChar(30) // ID đơn vị trực thuộc của Manager nộp đề xuất (nullable)
  nguoi_de_xuat_id     String    @db.VarChar(30) // ID tài khoản người đề xuất
  loai_de_xuat         String    @db.VarChar(20) // CA_NHAN_HANG_NAM, DON_VI_HANG_NAM, NIEN_HAN, CONG_HIEN, DOT_XUAT, NCKH
  nam                  Int       @default(2025) // Năm đề xuất
  status               String    @default("PENDING") @db.VarChar(20) // PENDING, APPROVED, REJECTED
  data_danh_hieu       Json? // Dữ liệu danh hiệu (JSON array) - cho HANG_NAM
  data_thanh_tich      Json? // Dữ liệu thành tích (JSON array) - cho HANG_NAM
  data_nien_han        Json? // Dữ liệu niên hạn (JSON array) - cho NIEN_HAN
  data_cong_hien       Json? // Dữ liệu cống hiến (JSON array) - cho CONG_HIEN
  files_attached       Json?     // Array các file đính kèm: [{ filename, originalName, size, uploadedAt }]
  ghi_chu              String?   @db.Text // Ghi chú từ Manager hoặc Admin
  rejection_reason     String?   @db.Text // Lý do từ chối (nếu status = REJECTED)
  nguoi_duyet_id       String?   @db.VarChar(30) // ID tài khoản Admin phê duyệt
  ngay_duyet           DateTime? @db.Timestamptz(6) // Ngày phê duyệt
  createdAt            DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @db.Timestamptz(6)

  // Relations
  CoQuanDonVi    CoQuanDonVi?    @relation(fields: [co_quan_don_vi_id], references: [id], onDelete: Cascade)
  DonViTrucThuoc DonViTrucThuoc? @relation(fields: [don_vi_truc_thuoc_id], references: [id], onDelete: Cascade)
  NguoiDeXuat    TaiKhoan        @relation("NguoiDeXuat", fields: [nguoi_de_xuat_id], references: [id], onDelete: Cascade)
  NguoiDuyet     TaiKhoan?       @relation("NguoiDuyet", fields: [nguoi_duyet_id], references: [id], onDelete: SetNull)

  @@map("bang_de_xuat")
}

// 15. Bảng Hồ Sơ Đơn Vị Hằng Năm
model HoSoDonViHangNam {
  id                        String    @id @default(cuid()) @db.VarChar(30)
  co_quan_don_vi_id         String?   @db.VarChar(30)
  don_vi_truc_thuoc_id      String?   @db.VarChar(30)
  nam                       Int
  tong_dvqt                 Int       @default(0)
  tong_dvqt_json            Json?     // Lưu chi tiết tong DVQT dạng JSON
  dvqt_lien_tuc             Int       @default(0)
  du_dieu_kien_bk_tong_cuc  Boolean   @default(false)
  du_dieu_kien_bk_thu_tuong Boolean   @default(false)
  goi_y                     String?   @db.Text
  createdAt                 DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt                 DateTime  @updatedAt @db.Timestamptz(6)

  // Relations
  CoQuanDonVi        CoQuanDonVi?    @relation(fields: [co_quan_don_vi_id], references: [id], onDelete: Cascade)
  DonViTrucThuoc     DonViTrucThuoc? @relation(fields: [don_vi_truc_thuoc_id], references: [id], onDelete: Cascade)

  @@unique([co_quan_don_vi_id, nam], name: "unique_co_quan_don_vi_nam")
  @@unique([don_vi_truc_thuoc_id, nam], name: "unique_don_vi_truc_thuoc_nam")
  @@index([co_quan_don_vi_id, nam])
  @@index([don_vi_truc_thuoc_id, nam])
  @@map("ho_so_don_vi_hang_nam")
}

// 17. Bảng Danh Hiệu Đơn Vị Hằng Năm
model DanhHieuDonViHangNam {
  id                      String   @id @default(cuid()) @db.VarChar(30)
  co_quan_don_vi_id       String?  @db.VarChar(30)
  don_vi_truc_thuoc_id    String?  @db.VarChar(30)
  nam                     Int
  danh_hieu               String?  @db.VarChar(50)
  so_quyet_dinh           String?  @db.VarChar(100)
  file_quyet_dinh         String?  @db.VarChar(255)
  nhan_bkbqp              Boolean  @default(false)
  so_quyet_dinh_bkbqp     String?  @db.VarChar(100)
  file_quyet_dinh_bkbqp   String?  @db.VarChar(500) // Path to PDF file BKBQP
  nhan_bkttcp             Boolean  @default(false)
  so_quyet_dinh_bkttcp    String?  @db.VarChar(100)
  file_quyet_dinh_bkttcp  String?  @db.VarChar(500) // Path to PDF file CSTDTQ
  status                  String    @default("PENDING") @db.VarChar(20)
  nguoi_tao_id            String    @db.VarChar(30)
  nguoi_duyet_id          String?   @db.VarChar(30)
  ngay_duyet              DateTime? @db.Timestamptz(6)
  ghi_chu                 String?   @db.Text
  createdAt               DateTime @default(now()) @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  CoQuanDonVi        CoQuanDonVi?    @relation(fields: [co_quan_don_vi_id], references: [id], onDelete: Cascade)
  DonViTrucThuoc     DonViTrucThuoc? @relation(fields: [don_vi_truc_thuoc_id], references: [id], onDelete: Cascade)

  @@unique([co_quan_don_vi_id, nam], name: "unique_co_quan_don_vi_nam_dh")
  @@unique([don_vi_truc_thuoc_id, nam], name: "unique_don_vi_truc_thuoc_nam_dh")
  @@index([co_quan_don_vi_id, nam])
  @@index([don_vi_truc_thuoc_id, nam])
  @@map("danh_hieu_don_vi_hang_nam")
}

// 18. Bảng File Quyết định
model FileQuyetDinh {
  id               String   @id @default(uuid()) @db.Uuid
  so_quyet_dinh    String   @unique @db.VarChar(100) // Số quyết định (unique)
  nam              Int // Năm quyết định
  ngay_ky          DateTime @db.Date // Ngày ký quyết định
  nguoi_ky         String   @db.VarChar(255) // Người ký (Tên + Chức vụ)
  file_path        String?  @db.VarChar(500) // Đường dẫn file PDF/Word
  loai_khen_thuong String?  @db.VarChar(50) // CA_NHAN_HANG_NAM, DON_VI_HANG_NAM, NIEN_HAN, CONG_HIEN, DOT_XUAT, NCKH
  ghi_chu          String?  @db.Text // Ghi chú
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)

  @@index([so_quyet_dinh])
  @@index([nam])
  @@index([loai_khen_thuong])
  @@map("file_quyet_dinh")
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "ERD.svg"
}
